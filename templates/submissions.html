{% extends "base.html" %}

{% block title %}æäº¤è®°å½• - {{ super() }}{% endblock %}

{% block content %}
<div class="submissions-container">
    <h2>{{ page_title }}</h2>

    <!-- åŠ¨æ€æ¶ˆæ¯å®¹å™¨ï¼ˆç”¨äºæ˜¾ç¤ºåŠ è½½çŠ¶æ€ã€é”™è¯¯ä¿¡æ¯ç­‰ï¼‰ -->
    <div id="messages" class="message-container" style="display: none;"></div>

    <!-- åŠ è½½ä¸­çš„å ä½ç¬¦ -->
    <div id="loading-state" class="loading-placeholder">
        <div class="spinner"></div>
        <p>æ­£åœ¨åŠ è½½æ‚¨çš„è®°å½•...</p>
    </div>

    <!-- ç©ºçŠ¶æ€æç¤ºï¼ˆå½“æ²¡æœ‰è®°å½•æ—¶æ˜¾ç¤ºï¼‰ -->
    <div id="empty-state" class="empty-state" style="display: none;">
        <p>ğŸ“­ æ‚¨è¿˜æ²¡æœ‰ä»»ä½•æäº¤è®°å½•ã€‚</p>
        <p><a href="{{ url_for('contact') }}">å»åˆ›å»ºç¬¬ä¸€æ¡è®°å½•</a></p>
    </div>

    <!-- è¡¨æ ¼å®¹å™¨ï¼Œæ•°æ®å°†åŠ¨æ€æ’å…¥åˆ°è¿™é‡Œ -->
    <div id="table-container" class="table-container" style="display: none;">
        <table class="submissions-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>å§“å</th>
                    <th>é‚®ç®±</th>
                    <th>ç±»å‹</th>
                    <th>ç•™è¨€æ‘˜è¦</th>
                    <th>è®¢é˜…</th>
                    <th>æäº¤æ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="submissions-tbody">
                <!-- è®°å½•è¡Œå°†é€šè¿‡JavaScriptåŠ¨æ€æ’å…¥åˆ°è¿™é‡Œ -->
            </tbody>
        </table>
    </div>

    <div class="page-actions">
        <a href="{{ url_for('contact') }}" class="btn btn-primary">â• åˆ›å»ºæ–°è®°å½•</a>
        <button id="refresh-btn" class="btn btn-secondary" title="åˆ·æ–°åˆ—è¡¨">
            ğŸ”„ åˆ·æ–°
        </button>
    </div>
</div>
{% endblock %}



{% block extra_css %}
<style>
    /* åŠ è½½çŠ¶æ€æ ·å¼ */
    .loading-placeholder {
        text-align: center;
        padding: 3rem;
        color: #7f8c8d;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* ç©ºçŠ¶æ€æç¤º */
    .empty-state {
        text-align: center;
        padding: 3rem;
        background-color: #f8f9fa;
        border-radius: 8px;
        color: #6c757d;
    }

    .empty-state a {
        color: #3498db;
    }

    /* è¡¨æ ¼å®¹å™¨ */
    .table-container {
        margin: 1.5rem 0;
        overflow-x: auto;
    }

    /* æ“ä½œæŒ‰é’® */
    .page-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .btn {
        padding: 0.6rem 1.5rem;
        border-radius: 4px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        border: none;
        cursor: pointer;
        font-size: 1rem;
    }

    .btn-primary {
        background-color: #3498db;
        color: white;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn-danger {
        background-color: #e74c3c;
        color: white;
        padding: 0.25rem 0.75rem;
        font-size: 0.9rem;
    }

    /* æ¶ˆæ¯æ ·å¼ï¼ˆå¤ç”¨é˜¶æ®µAçš„ï¼‰ */
    .message-container {
        margin-bottom: 1.5rem;
    }

    .alert {
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }

    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    /* æ’¤é”€æŒ‰é’®æ ·å¼ */
    .btn-warning {
        background-color: #ffc107;
        color: #212529;
        border: none;
        padding: 0.25rem 0.75rem;
        font-size: 0.9rem;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-warning:hover {
        background-color: #e0a800;
    }

    /* ä¿¡æ¯é€šçŸ¥æ ·å¼ */
    .notification-info {
        background-color: #17a2b8;
        border-left: 4px solid #138496;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- å¼•å…¥APIå®¢æˆ·ç«¯ -->
<script src="{{ url_for('static', filename='js/apiClient.js') }}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ç°åœ¨å¯ä»¥ä½¿ç”¨ ApiClient ä»£æ›¿åŸç”Ÿçš„ fetch
        async function handleFormSubmit(event) {
            event.preventDefault();

            // ä½¿ç”¨ ApiClient
            const result = await ApiClient.createSubmission(formData);

            if (result.ok && result.data.status === 'success') {
                // å¤„ç†æˆåŠŸ...
            } else {
                // å¤„ç†é”™è¯¯...
            }
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tbody = document.getElementById('submissions-tbody');
        const tableContainer = document.getElementById('table-container');
        const loadingState = document.getElementById('loading-state');
        const emptyState = document.getElementById('empty-state');
        const messagesContainer = document.getElementById('messages');
        const refreshBtn = document.getElementById('refresh-btn');

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–æ•°æ®
        loadSubmissions();

        // ç‚¹å‡»åˆ·æ–°æŒ‰é’®é‡æ–°åŠ è½½
        refreshBtn.addEventListener('click', loadSubmissions);

        // ä¸»å‡½æ•°ï¼šåŠ è½½æäº¤è®°å½•
        async function loadSubmissions() {
            showLoading();
            clearMessages();

            try {
                const response = await fetch('/api/submissions');

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${response.status}`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    renderSubmissions(result.data);
                    showMessage('success', `æˆåŠŸåŠ è½½ ${result.count} æ¡è®°å½•`);
                } else {
                    throw new Error(result.message || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½è®°å½•å¤±è´¥:', error);
                showMessage('error', `åŠ è½½å¤±è´¥: ${error.message}`);
                showEmptyState();
            } finally {
                hideLoading();
            }
        }

        // æ¸²æŸ“è®°å½•åˆ°è¡¨æ ¼
        function renderSubmissions(submissions) {
            // æ¸…ç©ºç°æœ‰è¡Œ
            tbody.innerHTML = '';

            if (submissions.length === 0) {
                showEmptyState();
                return;
            }

            // ä¸ºæ¯æ¡è®°å½•åˆ›å»ºè¡¨æ ¼è¡Œ
            submissions.forEach(sub => {
                const row = document.createElement('tr');

                // æ ¼å¼åŒ–æ—¥æœŸ
                const submittedDate = new Date(sub.submitted_at);
                const formattedDate = submittedDate.toLocaleDateString('zh-CN') + ' ' +
                    submittedDate.toLocaleTimeString('zh-CN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                // åˆ›å»ºè¡Œå†…å®¹
                row.innerHTML = `
                <td>#${sub.id}</td>
                <td>${escapeHtml(sub.name)}</td>
                <td><code>${escapeHtml(sub.email)}</code></td>
                <td><span class="category-badge ${sub.category}">${getCategoryText(sub.category)}</span></td>
                <td title="${escapeHtml(sub.message)}">${truncateText(sub.message, 50)}</td>
                <td>${sub.subscribe ? 'âœ“' : 'âœ—'}</td>
                <td><small>${formattedDate}</small></td>
                <td class="actions">
                    <button class="btn-danger delete-btn" data-id="${sub.id}" 
                            onclick="deleteSubmission(${sub.id}, this)">
                        åˆ é™¤
                    </button>
                </td>
            `;

                tbody.appendChild(row);
            });

            // æ˜¾ç¤ºè¡¨æ ¼ï¼Œéšè—ç©ºçŠ¶æ€
            tableContainer.style.display = 'block';
            emptyState.style.display = 'none';
        }

        // å…¨å±€åˆ é™¤å‡½æ•°ï¼ˆå› ä¸ºéœ€è¦åœ¨åŠ¨æ€ç”Ÿæˆçš„æŒ‰é’®ä¸Šä½¿ç”¨ï¼‰
        window.deleteSubmission = async function (id, buttonElement) {
            const row = buttonElement.closest('tr');
            const rowData = {
                id: id,
                html: row.innerHTML,
                element: row
            };

            // ä¸´æ—¶éšè—è¡Œï¼ˆè€Œä¸æ˜¯ç«‹å³åˆ é™¤ï¼‰
            row.style.opacity = '0.5';
            row.style.backgroundColor = '#fff3cd';

            // åˆ›å»ºæ’¤é”€æŒ‰é’®
            const undoButton = document.createElement('button');
            undoButton.className = 'btn-warning undo-btn';
            undoButton.innerHTML = 'â†¶ æ’¤é”€åˆ é™¤';
            undoButton.style.marginLeft = '0.5rem';

            // æ›¿æ¢åŸå§‹åˆ é™¤æŒ‰é’®
            const actionsCell = buttonElement.parentElement;
            actionsCell.innerHTML = '';
            actionsCell.appendChild(undoButton);

            // è®¾ç½®æ’¤é”€è¶…æ—¶ï¼ˆ7ç§’åçœŸæ­£åˆ é™¤ï¼‰
            const undoTimeout = setTimeout(() => {
                performDelete(id, row);
            }, 7000);

            // æ’¤é”€æŒ‰é’®äº‹ä»¶
            undoButton.onclick = function () {
                clearTimeout(undoTimeout);

                // æ¢å¤è¡Œ
                row.style.opacity = '1';
                row.style.backgroundColor = '';
                row.innerHTML = rowData.html;

                // é‡æ–°ç»‘å®šåˆ é™¤äº‹ä»¶åˆ°æ¢å¤çš„æŒ‰é’®
                const newDeleteBtn = row.querySelector('.delete-btn');
                if (newDeleteBtn) {
                    newDeleteBtn.onclick = function () {
                        deleteSubmission(id, newDeleteBtn);
                    };
                }

                ErrorHandler.showSuccess('åˆ é™¤å·²å–æ¶ˆ');
            };

            // æ˜¾ç¤ºæ’¤é”€æç¤º
            const message = `è®°å½• #${id} å·²æ ‡è®°åˆ é™¤ã€‚7ç§’åç”Ÿæ•ˆã€‚`;
            ErrorHandler.showInfo(message, 7000);
        };

        // å®é™…æ‰§è¡Œåˆ é™¤çš„å‡½æ•°
        async function performDelete(id, row) {
            try {
                const result = await ApiClient.deleteSubmission(id);

                if (result.ok && result.data.status === 'success') {
                    // å¹³æ»‘åˆ é™¤åŠ¨ç”»
                    row.style.transition = 'all 0.3s ease';
                    row.style.height = row.offsetHeight + 'px';

                    setTimeout(() => {
                        row.style.height = '0';
                        row.style.opacity = '0';
                        row.style.padding = '0';
                        row.style.margin = '0';
                        row.style.border = 'none';
                    }, 10);

                    setTimeout(() => {
                        if (row.parentNode) {
                            row.parentNode.removeChild(row);
                        }

                        // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰è®°å½•
                        if (tbody.children.length === 0) {
                            showEmptyState();
                        }
                    }, 400);

                    ErrorHandler.showSuccess(result.data.message);
                } else {
                    throw new Error(ErrorHandler.getFriendlyMessage(result));
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                ErrorHandler.showError(`åˆ é™¤å¤±è´¥: ${error.message}`);

                // æ¢å¤è¡Œ
                row.style.opacity = '1';
                row.style.backgroundColor = '';
            }
        };

        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            loadingState.style.display = 'block';
            tableContainer.style.display = 'none';
            emptyState.style.display = 'none';
        }

        function hideLoading() {
            loadingState.style.display = 'none';
        }

        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºç©ºçŠ¶æ€
        function showEmptyState() {
            tableContainer.style.display = 'none';
            emptyState.style.display = 'block';
        }

        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(type, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type}`;
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.style.display = 'block';

            // 5ç§’åè‡ªåŠ¨ç§»é™¤ï¼ˆæˆåŠŸæ¶ˆæ¯ï¼‰
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.remove();
                    if (messagesContainer.children.length === 0) {
                        messagesContainer.style.display = 'none';
                    }
                }, 5000);
            }
        }

        function clearMessages() {
            messagesContainer.innerHTML = '';
            messagesContainer.style.display = 'none';
        }

        // å·¥å…·å‡½æ•°ï¼šæˆªæ–­æ–‡æœ¬
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return escapeHtml(text);
            return escapeHtml(text.substring(0, maxLength)) + '...';
        }

        // å·¥å…·å‡½æ•°ï¼šHTMLè½¬ä¹‰ï¼ˆé˜²æ­¢XSSï¼‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // å·¥å…·å‡½æ•°ï¼šè·å–ç±»å‹æ–‡æœ¬
        function getCategoryText(category) {
            const map = {
                'general': 'ä¸€èˆ¬',
                'technical': 'æŠ€æœ¯',
                'feedback': 'åé¦ˆ',
                'other': 'å…¶ä»–'
            };
            return map[category] || category;
        }
    });
</script>
{% endblock %}